;(function(){Venus.Topology={}})();(function(){var index=0;var Node=function(info){this.info=info;this.id=info.id;this.parents=[];this.children=[];this._parentsHash={};this._childrenHash={};this.parentsEdges=[];this.childrenEdges=[];Node.index++};Node.prototype={addParent:function(parent){!this._exist(this.parents,parent)&&this.parents.push(parent)&&(this._parentsHash[parent.id]=parent)},addParentEdge:function(edge){this.parentsEdges.push(edge)},addChild:function(child){!this._exist(this.children,child)&&this.children.push(child)&&(this._childrenHash[child.id]=child)},addChildEdge:function(edge){this.childrenEdges.push(edge)},hasChild:function(node){return!!this._childrenHash[node.id]},hasParent:function(node){return!!this._parentsHash[node.id]},setIndex:function(i){this.indexInLayer=i},setGraph:function(graph){this.graph=graph},getIndex:function(){return this.indexInLayer},_exist:function(parentsOrChildren,node){var exist=false;parentsOrChildren.forEach(function(d){if(d.id===node.id){exist=true}});return exist},render:function(paper,type,x,y,radius){this.type=type;this.view=Node.types[type].create.call(this,paper,x,y,radius);this.view.data('node',this)},position:function(x,y){return Node.types[this.type].position.call(this,x,y)},highlight:function(){var attr={'stroke':'#FF6600','stroke-width':2};if(!this.isHighlight){this.isHighlight=true;this.viewCache={'stroke':this.view.attr('stroke'),'stroke-width':this.view.attr('stroke-width')};this.view.attr(attr);return true}},cancelHighlight:function(){if(this.isHighlight){this.isHighlight=false;this.view.attr(this.viewCache);return true}}};Node.types={};Node.extend=function(type,interfaces){Node.types[type]=interfaces};Node.extend('circle',{create:function(paper,x,y,radius){return paper.circle(x,y,radius)},position:function(x,y){if(x===undefined&&y===undefined){return{x:this.view.attr('cx'),y:this.view.attr('cy')}}this.view.attr({"x":x,"y":y})}});Node.extend('rect',{create:function(paper,x,y,radius){return paper.rect(x-radius,y-radius,radius*2,radius*2)},position:function(x,y){if(x===undefined&&y===undefined){return{x:this.view.attr('x')+this.view.attr('width')/2,y:this.view.attr('y')+this.view.attr('height')/2}}this.view.attr({"x":x-this.view.attr('width')/2,"y":y-this.view.attr('height')/2})}});Venus.Topology.Node=Node;Node.index=0})();(function(V){V.initController=function(group,stage,chartWidth,chartHeight,options,x,y){var scaledX=1,scaledY=1,translatedX=x||0,translatedY=y||0 var scale=function(lager){if(lager){scaledX*=1.25;scaledY*=1.25}else{scaledX/=1.25;scaledY/=1.25}group.transform('S'+scaledX+","+scaledY+","+chartWidth/2+","+chartHeight/2+"T"+translatedX+","+translatedY)},move=function(x,y){translatedX+=x;translatedY+=y;group.transform('S'+scaledX+","+scaledY+","+chartWidth/2+","+chartHeight/2+"T"+translatedX+","+translatedY)},lastX,lastY,openHandUrl='http://maps.gstatic.cn/intl/zh-CN_cn/mapfiles/openhand_8_8.cur',closeHandUrl='http://maps.gstatic.cn/intl/zh-CN_cn/mapfiles/closedhand_8_8.cur'stage.canvas.style.cursor='url("'+openHandUrl+'"), move';this.container.style.boxShadow="0 0 1px 1px #ccc inset";var mousewheel=navigator.userAgent.indexOf('Firefox')==-1?'mousewheel':'DOMMouseScroll'stage.canvas.addEventListener(mousewheel,function(e){e.preventDefault();scale(e.wheelDelta!==undefined?e.wheelDelta>0:e.detail<0)},false);(new Raphael.el.constructor(stage.canvas,stage)).drag(function(dx,dy,x,y,e){move(dx-lastX,dy-lastY);lastX=dx;lastY=dy},function(){stage.canvas.style.cursor='url("'+closeHandUrl+'"),move';lastX=0;lastY=0},function(){stage.canvas.style.cursor='url("'+openHandUrl+'"),move'});var panel=stage.g(),moveCircle,moveLeft,moveTop,moveRight,moveBottom,cx=31,cy=31,r=30,arrowPadding=5,arrowHeight=10,arrowWeight=6,arrowInnerHeight=arrowHeight-arrowWeight moveCircle=stage.circle(cx,cy,r).attr({'stroke':'#ccc','stroke-width':1,'fill':'#fff','cursor':'default'});panel.node.appendChild(moveCircle.node);moveTop=stage.path().attr({'path':['M',cx,arrowPadding,'l',-arrowHeight,arrowHeight,'h',arrowWeight,'l',arrowInnerHeight,-arrowInnerHeight,'l',arrowInnerHeight,arrowInnerHeight,'h',arrowWeight,'l',-arrowHeight,-arrowHeight,'z'],'fill':"#999999",'stroke':'none','cursor':'pointer'});panel.node.appendChild(moveTop.node);moveLeft=moveTop.clone().transform('r'+ -90+','+cx+","+arrowPadding+'t'+(arrowPadding-r)+","+(arrowPadding-r)).click(function(e){e.stopPropagation();move(chartWidth/10,0)});panel.node.appendChild(moveLeft.node);moveRight=moveTop.clone().transform('r'+90+','+cx+','+arrowPadding+'t'+(r-arrowPadding)+","+(arrowPadding-r)).click(function(e){e.stopPropagation();move(-chartWidth/10,0)});panel.node.appendChild(moveRight.node);moveBottom=moveTop.clone().transform('r'+180+','+cx+','+arrowPadding+'t'+0+","+2*(arrowPadding-r)).click(function(e){e.stopPropagation();move(0,-chartHeight/10)})panel.node.appendChild(moveBottom.node);moveTop.click(function(e){e.stopPropagation();move(0,chartHeight/10)});var plus,minus,plusText,minusText,fullScreen,fullScreenArrow,existFullScreen,existFullScreenArrow,container=this.container,marginLeft=10,marginTop=5,rectWidth=20 plus=stage.rect(2*(r+1)+marginLeft,marginTop,rectWidth,rectWidth).attr({'stroke':'#000','stroke-width':1,'stroke-opacity':.5,'cursor':'pointer','fill':'#fff'});minus=plus.clone().attr({'y':2*(r+1)-1-rectWidth-marginTop});plusText=stage.text(2*(r+1)+marginLeft+rectWidth/2,marginTop+1+rectWidth/2,'+').attr({'font-size':16,'cursor':'pointer'});minusText=stage.text(2*(r+1)+marginLeft+rectWidth/2,2*(r+1)-1-marginTop-1-rectWidth/2,'-').attr({'font-size':16,'cursor':'pointer'});panel.node.appendChild(plus.node);panel.node.appendChild(minus.node);panel.node.appendChild(plusText.node);panel.node.appendChild(minusText.node);plus.click(function(e){e.stopPropagation();scale(true)});plusText.click(function(e){e.stopPropagation();scale(true)});minus.click(function(e){e.stopPropagation();scale(false)});minusText.click(function(e){e.stopPropagation();scale(false)});fullScreen=plus.clone().attr('x',2*(r+1)+marginLeft*2+2+rectWidth);panel.node.appendChild(fullScreen.node);fullScreen.click(function(e){var container=stage.canvas container.requestFullScreen?container.requestFullScreen():(container.webkitRequestFullScreen?container.webkitRequestFullScreen():(container.mozRequestFullScreen&&container.mozRequestFullScreen()))});fullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth*2)+","+2+'r'+45+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(fullScreenArrow.node);fullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth+4)+","+2+'r'+(-45)+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(fullScreenArrow.node);fullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth*2)+","+(rectWidth-2)+'r'+135+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(fullScreenArrow.node);fullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth+4)+","+(rectWidth-2)+'r'+(-135)+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(fullScreenArrow.node);existFullScreen=minus.clone().attr('x',2*(r+1)+marginLeft*2+2+rectWidth);panel.node.appendChild(existFullScreen.node);existFullScreen.click(function(e){e.stopPropagation();document.exitFullScreen?document.existFullScreen():(document.webkitCancelFullScreen?document.webkitCancelFullScreen():(document.mozCancelFullScreen&&document.mozCancelFullScreen()))});existFullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth*1.5+4)+","+(2*(r+1)-rectWidth)+'r'+(-45)+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(existFullScreenArrow.node);existFullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth*1.5)+","+(2*r-rectWidth)+'r'+135+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(existFullScreenArrow.node);existFullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth*1.5+4)+","+(2*r-rectWidth)+'r'+(-135)+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(existFullScreenArrow.node);existFullScreenArrow=moveTop.clone().transform("t"+(r+1+marginLeft*2+rectWidth*1.5)+","+(2*(r+1)-rectWidth)+'r'+45+","+cx+","+arrowPadding+"s.5,.5,"+cx+","+arrowPadding)panel.node.appendChild(existFullScreenArrow.node);var panelWidth=(2*(r+1)+marginLeft*2+4+rectWidth*2)function adjust(){if(document.webkitIsFullScreen||document.mozFullScreen){stage.setSize(window.screen.width,window.screen.height);panel.transform('T'+(window.screen.width-panelWidth-20)+","+10)}else{stage.setSize(chartWidth,chartHeight);panel.transform('T'+(chartWidth-panelWidth-20)+','+10)}}stage.canvas.addEventListener('webkitfullscreenchange',adjust,false);document.addEventListener('mozfullscreenchange',adjust,false)panel.transform('T'+(chartWidth-panelWidth-20)+','+10)}})(Venus);(function(){Raphael._engine.g=function(svg){var ns='http://www.w3.org/2000/svg';var el=document.createElementNS(ns,'g')svg.canvas&&svg.canvas.appendChild(el);var res=new Raphael.el.constructor(el,svg);res.type="g";el.setAttributeNS(ns,'fill','#fff')return res};Raphael.fn.g=function(){var out=Raphael._engine.g(this);this.__set__&&this.__set__.push(out);return out};var STRAITLINE='straightline',POLYLINE="polyline",PARENT_ON_TOP='parent_on_top',PARENT_ON_BOTTOM='parent_on_bottom',PARENT_TO_CHILD='parent_to_child',CHILD_TO_PARENT='child_to_parent';var Topology=Venus.Topology;var Graph=function(container,data,opt){if(!container||!container.nodeType){return}this.container=container;this.data=data||[];var options=this.options=Venus.util.mix({width:container.clientWidth,height:container.clientHeight,layerDirection:PARENT_ON_TOP,arrowDirection:PARENT_TO_CHILD,padding:40,layerHeight:null,nodeRadius:30,nodeType:'circle',arrowLength:10,arrowWidth:1,colorMap:{1:'#FF0000',2:'#7CFC00',3:'#B1C9ED'},badStatus:[],align:'left',singleMax:4,edgeType:STRAITLINE,enableController:true,useAsText:'text',enableDrag:true,keepLayerWhenDrag:false,click:function(data){},mouseover:function(data){},mouseout:function(data){},contextmenu:function(e,node){},showCrossLayerEdge:false,reduceCrossing:true},Venus.util.clone(opt||{})),stage=this.stage=new Raphael(container,options.width,options.height),self=this;this._prepareNodes();this._layNodes();if(options.layerDirection==PARENT_ON_BOTTOM){this.graphs.forEach(function(graph){graph.resultLayers.reverse()})}this.graphs.sort(function(a,b){return b.resultLayers.length-a.resultLayers.length});options.reduceCrossing&&this._reduceCrossing();Object.keys(this.nodes).forEach(function(id){var node=self.nodes[id];node.parents.sort(function(a,b){return a.indexInLayer-b.indexInLayer})});this._renderNodes();this._renderEdges();options.showCrossLayerEdge&&this._renderCrossLayerEdges();options.badStatus.length&&this._focusBad();options.enableDrag&&this._enableDrag();if(options.enableController){Venus.initController.call(this,self.group,stage,options.width,options.height,options,self.transformX,self.transformY)}};Graph.prototype={_prepareNodes:function(){var noParentNodes={},noChildrenNodes={},nodes={},self=this;function operateParents(d,parents){var id=d.id;if(parents&&parents.length){parents.forEach(function(pid){var node=nodes[pid];if(!node){self.data.forEach(function(dd){if(dd.id==pid){node=new Topology.Node(dd);nodes[pid]=node;noParentNodes[pid]=node}})}if(node){d.addParent(node);node.addChild(d);delete noParentNodes[id];delete noChildrenNodes[pid]}})}}function operateChildren(d,children){var id=d.id;children.forEach(function(cid){var node=nodes[cid];if(!node){self.data.forEach(function(dd){if(dd.id==cid){node=new Venus.Topology.Node(dd);nodes[cid]=node;noChildrenNodes[cid]=node}})}if(node){d.addChild(node);node.addParent(d);delete noChildrenNodes[id];delete noParentNodes[cid]}})}this.data.forEach(function(d){var id=d.id,node;if(!id){return}node=nodes[id];if(!nodes[id]){node=new Venus.Topology.Node(d);noParentNodes[id]=node;noChildrenNodes[id]=node;nodes[id]=node}operateChildren(node,d.children);operateParents(node,d.parents)});this.nodes=nodes;this.noParentNodes=noParentNodes;this.noChildNodes=noChildrenNodes},_layNodes:function(){var roots,graphs=[],laidNodes={},crossLayerEdges=[],hasThisEdge=function(edges,from,to){var has=false;edges.forEach(function(edge){if(edge.from==from&&edge.to==to){has=true}});return has},lay=function(node,layer,layers,edges){layers[layer]||(layers[layer]=[]);edges[layer]||(edges[layer]=[]);if(laidNodes[node.id]){return false}laidNodes[node.id]=true;layers[layer].push(node);node._layer=layer;return true},layRelation=function(nodes,layers,edges){if(!Venus.util.isArray(nodes)||!nodes.length){return}var parents=[],children=[];nodes.forEach(function(node){var currentLayer=node._layer;if(node.children&&node.children.length){node.children.forEach(function(child){if(lay(child,node._layer+1,layers,edges)){children.push(child)}if(hasThisEdge(edges[node._layer],node,child)){return}var edge={from:node,to:child};if(layers[node._layer+1].indexOf(child)!=-1){edge.node1=node;edge.node2=child;edges[node._layer].push(edge)}else if(layers[node._layer-1]&&layers[node._layer-1].indexOf(child)!=-1){edge.node1=child;edge.node2=node;edges[node._layer-1].push(edge)}else{crossLayerEdges.push(edge)}})}if(node.parents&&node.parents.length){node.parents.forEach(function(parent){if(lay(parent,currentLayer-1,layers,edges)){parents.push(parent)}if(hasThisEdge(edges[currentLayer-1],parent,node)){return}var edge={from:parent,to:node};if(layers[currentLayer-1].indexOf(parent)!=-1){edge.node1=parent;edge.node2=node;edges[currentLayer-1].push(edge)}else if(layers[currentLayer+1]&&layers[currentLayer+1].indexOf(parent)!=-1){edge.node1=node;edge.node2=parent;edges[currentLayer].push(edge)}else{crossLayerEdges.push(edge)}})}});layRelation(children.concat(parents),layers,edges)};roots=this.noParentNodes;Object.keys(roots).forEach(function(id){var node=roots[id];if(laidNodes[id]){return}var layers={},resultLayers=[],tempEdgeGroups={},edgeGroups=[],graph={layers:layers,resultLayers:resultLayers,start:node,edgeGroups:edgeGroups},base=0;graphs.push(graph);if(lay(node,base,layers,tempEdgeGroups)){layRelation([node],layers,tempEdgeGroups)}Object.keys(layers).sort(function(a,b){return a-b}).filter(function(a){return!!layers[a].length}).forEach(function(key){resultLayers.push(layers[key]);layers[key].forEach(function(node,i){node.setIndex(i);node.setGraph(graph)})});Object.keys(tempEdgeGroups).sort(function(a,b){return a-b}).filter(function(a){return!!tempEdgeGroups[a].length}).forEach(function(key){edgeGroups.push(tempEdgeGroups[key])})});this.graphs=graphs;this.crossLayerEdges=crossLayerEdges},_reduceCrossing:function(){var self=this;this.graphs.forEach(function(graph,i){if(i!==0){return}var edgeGroup=graph.edgeGroups,layers=graph.resultLayers;edgeGroup.forEach(function(edges,i){var weight={},nodesWithEdge=[],index=0;edges.forEach(function(edge){var node2Id=edge.node2.id;weight[node2Id]||((weight[node2Id]={value:0,count:0})&&nodesWithEdge.push(edge.node2));weight[node2Id].value+=edge.node1.getIndex();weight[node2Id].count++});nodesWithEdge.sort(function(a,b){var aId=a.id,bId=b.id;return weight[aId].value/weight[aId].count-weight[bId].value/weight[bId].count});layers[i+1].map(function(n,m){return weight[n.id]?nodesWithEdge[index++]:n});layers[i+1].forEach(function(node,j){node.setIndex(j)})});for(var l=edgeGroup.length-1;l>=0;l--){var weight={},nodesWithEdge=[],edges=edgeGroup[l],index=0;edges.forEach(function(edge){var node1Id=edge.node1.id;weight[node1Id]||((weight[node1Id]={value:0,count:0})&&nodesWithEdge.push(edge.node1));weight[node1Id].value+=edge.node2.getIndex();weight[node1Id].count++});nodesWithEdge.sort(function(a,b){var aId=a.id,bId=b.id;return weight[aId].value/weight[aId].count-weight[bId].value/weight[bId].count});layers[l].map(function(n,m){return weight[n.id]?nodesWithEdge[index++]:n});layers[l].forEach(function(node,j){node.setIndex(j)})}})},_renderNodes:function(){var options=this.options,chartWidth=options.width,chartHeight=options.height,stage=this.stage,self=this,group=stage.g(),currentY=options.padding,currentIndex=0,width,height;this.group=group;function drawNode(node,x,y){node.render(stage,options.nodeType,x,y,options.nodeRadius);var _circle=node.view.attr({fill:options.colorMap[node.info.status],'stroke':'none','stroke-width':1,cursor:'pointer'}).click(function(e){if(this._isDragging){this._isDragging=false;return}options.click.call(this,e,node)}).mouseover(function(e){if(this._isDragging){this._isDragging=false;return}options.mouseover.call(this,e,node)}).mouseout(function(e){if(this._isDragging){this._isDragging=false;return}options.mouseout.call(this,e,node)});if(options.contextmenu){_circle.node.addEventListener('contextmenu',function(e){options.contextmenu.call(_circle,e,node)})}group.node.appendChild(_circle.node);return _circle}this.graphs.forEach(function(graph,i){var _circles=stage.set(),_texts=stage.set(),relation={},_edges=stage.set(),layers=graph.resultLayers,max=options.singleMax,right=100;if(i==0){var maxLengthInLayer;maxLengthInLayer=Math.max.apply(Math,layers.map(function(layer){return layer.length}))||1;maxLengthInLayer==2&&(maxLengthInLayer=3);height=options.layerHeight||(layers.length>1?(chartHeight-options.padding*2)/(layers.length-1):(chartHeight-options.padding*2));width=maxLengthInLayer>1?(chartWidth-options.padding*2)/(maxLengthInLayer-1):0;if(options.enableController){width<4*options.nodeRadius&&(width=4*options.nodeRadius);height<4*options.nodeRadius&&(height=4*options.nodeRadius)}self.layerHeight=height;layers.forEach(function(layer,i){var startX=options.align=="left"?options.nodeRadius:(chartWidth-(layer.length-1)*width)/2;layer.forEach(function(node,j){var x=startX+j*width,y=i*height+options.padding;var color=options.colorMap[node.info.status]||'green',rgb=Raphael.getRGB(color),hsl=Raphael.rgb2hsl(rgb.r,rgb.g,rgb.b),_circle,_text;_circle=drawNode(node,x,y);_circles.push(_circle);_text=stage.text(x,y,options.useAsText===undefined?node.id:node.info[options.useAsText]);group.node.appendChild(_text.node);_texts.push(_text)})})}else{if(layers.length>1){layers.forEach(function(layer,i){var startX=(options.align=="left"?-options.nodeRadius:-(chartWidth-(layer.length-1)*width)/2)-right,startY=currentY;layer.forEach(function(node,j){var x=startX-j*width,y=startY;var color=options.colorMap[node.info.status]||'green',rgb=Raphael.getRGB(color),hsl=Raphael.rgb2hsl(rgb.r,rgb.g,rgb.b),_circle,_text;_circle=drawNode(node,x,y);_circles.push(_circle);_text=stage.text(x,y,options.useAsText===undefined?node.id:node.info[options.useAsText]);group.node.appendChild(_text.node);_texts.push(_text)});currentY+=height})}else{if(layers[0]&&layers[0][0]){var node=layers[0][0],x=-options.nodeRadius-(currentIndex%max)*width-right,y=height*Math.floor(currentIndex/max)+currentY;var _circle=drawNode(node,x,y);_circles.push(_circle);var _text=stage.text(x,y,options.useAsText===undefined?node.id:node.info[options.useAsText]);group.node.appendChild(_text.node);_texts.push(_text);currentIndex++}}}graph.relation=relation;graph.nodeElements=_circles;graph.textElements=_texts})},_renderEdges:function(){var group=this.group,options=this.options,stage=this.stage,self=this;this.graphs.forEach(function(graph,i){graph.edgeGroups.forEach(function(layer,i){layer.forEach(function(edge){self.arrow(stage,edge,(self.layerHeight-2*options.nodeRadius-options.arrowLength*2)/graph.resultLayers[i].length);group.node.appendChild(edge.line.node);group.node.appendChild(edge.arrow.node);edge.from.addChildEdge(edge);edge.to.addParentEdge(edge)})})})},_renderCrossLayerEdges:function(){var self=this,stage=self.stage,group=self.group;this.crossLayerEdges.forEach(function(edge){self.arrow(stage,edge);group.node.appendChild(edge.line.node);group.node.appendChild(edge.arrow.node);edge.from.addChildEdge(edge);edge.to.addParentEdge(edge)})},_focusBad:function(){var self=this;for(var i=0,l=this.graphs.length;i<l;i++){for(var j=0,len=this.graphs[i].resultLayers.length;j<len;j++){for(var k=0,length=this.graphs[i].resultLayers[j].length;k<length;k++){var node=this.graphs[i].resultLayers[j][k];if(self.options.badStatus.indexOf(node.info.status)!==-1){self.transformX=0;self.transformY=-node.position().y+self.options.nodeRadius;self.group.transform('T'+self.transformX+","+self.transformY);return}}}}},straightPath:function(x1,y1,x2,y2){var options=this.options,r=options.nodeRadius,arrowLength=options.arrowLength,length=Math.sqrt(Math.pow(y2-y1,2)+Math.pow(x2-x1,2))-2*r,alpha,path=['M',x1+r,y1,"h",length],arrowPath=['M',x1+r+length,y1,'l',-arrowLength,-arrowLength/2,'l',arrowLength/2,arrowLength/2,-arrowLength/2,arrowLength/2,arrowLength,-arrowLength/2],rx=x1,ry=y1;if(y1==y2){if(x1>x2){alpha=Math.PI}else{alpha=0}}else{alpha=(Math.acos((x2-x1)/(length+2*r))*(y1>y2?1:-1))}if(options.nodeType=="rect"){length=Math.sqrt(Math.pow(Math.abs(y1-y2)-2*r,2)+Math.pow(x2-x1,2));alpha=Math.acos((x2-x1)/length)*(y1>y2?1:-1);path=['M',x1,(y1>y2?y1-r:y1+r),'h',length];arrowPath=['M',x1+length,(y1>y2?y1-r:y1+r),'l',-arrowLength,-arrowLength/2,'l',arrowLength/2,arrowLength/2,-arrowLength/2,arrowLength/2,arrowLength,-arrowLength/2]rx=x1;ry=(y1>y2?y1-r:y1+r);if(y1==y2){length=Math.abs(x1-x2)-2*r;path=['M',x1+r,y1,'h',length];arrowPath=['M',x1+r+length,y1,'l',-arrowLength,-arrowLength/2,'l',arrowLength/2,arrowLength/2,-arrowLength/2,arrowLength/2,arrowLength,-arrowLength/2]ry=y1;if(x1>x2){alpha=Math.PI}else{alpha=0}}}return{path:path,arrowPath:arrowPath,alpha:360-alpha*180/Math.PI,x:rx,y:ry}},arrow:function(paper,edge,unitHeight){var pos1=edge.from.position(),pos2=edge.to.position(),x1=parseInt(pos1.x),y1=parseInt(pos1.y),x2=parseInt(pos2.x),y2=parseInt(pos2.y),options=this.options,path;if(options.edgeType==POLYLINE&&y1<y2){var hasStraight,straightIndex,xOffset;edge.to.parents.forEach(function(p,i){if(parseInt(p.position().x)==x2){straightIndex=i;hasStraight=true}});if(x1===x2){xOffset=0}else{if(hasStraight){xOffset=options.arrowLength*(edge.to.parents.indexOf(edge.from)-straightIndex)}else{xOffset=options.arrowLength*(edge.to.parents.indexOf(edge.from)-Math.floor(edge.to.parents.length/2))}}path=this.polyLinePath(x1,y1,x2,y2,xOffset,(edge.from.indexInLayer+1)*unitHeight)}else{path=this.straightPath(x1,y1,x2,y2)}edge.arrow=(edge.arrow||paper.path()).attr({path:path.arrowPath,'fill':'#999',stroke:'none'});edge.line=(edge.line||paper.path()).attr({'path':path.path,'stroke-width':options.arrowWidth,'stroke':'#999'});edge.line.transform('R'+path.alpha+","+path.x+","+path.y);edge.arrow.transform('R'+path.alpha+","+path.x+","+path.y);if(y1>y2){edge.arrow.attr('fill','#999');edge.line.attr('stroke','#999')}},polyLinePath:function(x1,y1,x2,y2,xOffset,yOffset){var options=this.options,radius=options.nodeRadius,arrowLength=options.arrowLength,arrowPath,path;if(y1<y2){if(x1==x2){path=["M",x1,y1+radius,'V',y2-radius,'M',x2,y2-radius,'l',-arrowLength/2,-arrowLength,'l',arrowLength/2,arrowLength/2,'l',arrowLength/2,-arrowLength/2,'l',-arrowLength/2,arrowLength];arrowPath=['M',x2,y2-radius,'l',-arrowLength/2,-arrowLength,'l',arrowLength/2,arrowLength/2,'l',arrowLength/2,-arrowLength/2,'l',-arrowLength/2,arrowLength]}else{path=["M",x1,y1+radius,'v',yOffset,'H',x2+xOffset,'V',y2-radius];arrowPath=['M',x2+xOffset,y2-radius,'l',-arrowLength/2,-arrowLength,'l',arrowLength/2,arrowLength/2,'l',arrowLength/2,-arrowLength/2,'l',-arrowLength/2,arrowLength]}}else{if(x1==x2){path=["M",x1,y1-radius,'V',y2+radius];arrowPath=['M',x2,y2+radius,'l',-arrowLength/2,arrowLength,'l',arrowLength/2,-arrowLength/2,'l',arrowLength/2,arrowLength/2,'l',-arrowLength/2,-arrowLength]}else{path=["M",x1,y1-radius,'v',-yOffset,'H',x2+xOffset,'V',y2+radius];arrowPath=['M',x2+xOffset,y2+radius,'l',-arrowLength/2,arrowLength,'l',arrowLength/2,-arrowLength/2,'l',arrowLength/2,arrowLength/2,'l',-arrowLength/2,-arrowLength]}}return{path:path,arrowPath:arrowPath,alpha:0}},_enableDrag:function(){var self=this;self.graphs.forEach(function(graph){graph.nodeElements.forEach(function(circle,i){var currentX,currentY;circle.drag(function(dx,dy,x,y,e){e.stopPropagation();var targetX,targetY;this._isDragging=true;targetX=dx+currentX;targetY=dy+currentY;if(self.options.keepLayerWhenDrag){this.attr({cx:targetX});targetY=currentY}else{this.attr({cx:targetX,cy:targetY})}this.data('node').position(targetX,targetY);graph.textElements[i].attr({x:targetX,y:targetY});var node=circle.data('node');node.parentsEdges.forEach(function(edge){self.arrow(self.stage,edge)});node.childrenEdges.forEach(function(edge){self.arrow(self.stage,edge)})},function(x,y,e){e.stopPropagation();currentX=this.data('node').position().x;currentY=this.data('node').position().y},function(e){e.stopPropagation()})})})},highlightParents:function(node){var parents=[];function h(n){if(parents.indexOf(n)!==-1){return false}parents.push(n);n.highlight();n.parentsEdges.forEach(function(edge){edge.viewCache={arrow:{'fill':edge.arrow.attr('fill')},line:{'stroke':edge.line.attr('stroke')}};edge.arrow.attr('fill','#FF6600');edge.line.attr('stroke','#FF6600');edge.line.attr('stroke-width',2)});n.parents.forEach(function(p){h(p)})}h(node)},cancelHighlightParents:function(node){var parents=[];function h(n){if(parents.indexOf(n)!==-1){return false}parents.push(n);n.cancelHighlight();n.parentsEdges.forEach(function(edge){if(edge.viewCache){edge.arrow.attr(edge.viewCache.arrow);edge.line.attr(edge.viewCache.line)}});n.parents.forEach(function(p){h(p)})}h(node)}};Venus.util.mix(Graph,Venus.Topology);Venus.Topology=Graph})();