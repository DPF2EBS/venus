<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Venus Show Stage</title>
<link type="text/css" rel="stylesheet" href="Styles/SyntaxHighlighter.css"></link>
<link type="text/css" rel="stylesheet" href="Styles/page.css"></link>
<!--[if IE 6]>
    <script src="Scripts/DD_belatedPNG.js"></script>
    <script>DD_belatedPNG.fix('.pngfix'); </script>
<![endif]-->
</head>
<body>
	<div class="header">
    	<div class="header-cont clearfix">
            <a class="header-logo" href="#logo"><img src="image/logo.png" /></a>
            <div class="header-nav">
            	<ul>
                	<li><a href="index.html">首页</a></li>
                    <li><a href="api.html">接口文档</a></li>
                    <li class="J_menu">
						<a href="canvaspie.html" class="J_trigger">演示</a>
						<ul class="demo-menu J_list Hide">
							<li><a href="canvaspie.html">canvas</a></li>
							<li><a href="svgpie.html">svg</a></li>
						</ul>
					</li>
                    <li class="J_menu">
						<a href="canvascase.html" class="J_trigger">案例</a>
						<ul class="demo-menu J_list Hide">
							<li><a href="canvascase.html">canvas</a></li>
							<li><a href="svgcase.html">svg</a></li>
						</ul>
					</li>
                </ul>
            </div>
        </div>
    </div>

    <div class="cont-main margin-t clearfix">
    	<div class="nav-side">
        	<ul class="nav-list clearfix">
                <li><a href="#">使用教程</a></li>
                <li><a href="#">svg配置</a></li>
                <li><a href="#">canvas配置</a></li>
                <li><a href="#">api</a></li>
            </ul>
        </div>
        <div class="right-cont">
            <div class="mark-panel">
                <div class="isay-top pngfix"></div>
                <div class="isay-middle pngfix">
                    <div class="mark-box clearfix">
                        <h2>（1）步骤一：用户配置初始化代码</h2>
                    </div>
                </div>
                <div class="isay-bottom pngfix"></div>
            </div>
            <textarea name="code" class="js" rows="50" cols="100">
                // 生成饼图
                var container = document.getElementById('chart_container'),
                    bingData = [25,30,40,10,60,15,9,20,25,33],
                    bingOptions = {
                        pie:{
                            /*x:220,
                            y:220,
                            radius:90*/
                        }
                    };
                new DPChart(container, bingData, bingOptions);
            </textarea>

            <div class="mark-panel">
                <div class="isay-top pngfix"></div>
                <div class="isay-middle pngfix">
                    <div class="mark-box clearfix">
                        <h2>（2）步骤二：发生了什么？利用原型来实现构造函数</h2>
                    </div>
                </div>
                <div class="isay-bottom pngfix"></div>
            </div>
            <textarea name="code" class="js" rows="50" cols="100">
            /*
             * Class DPChart
             * @param container{HTMLElement} container for Kinetic
             * @param data{Array} Array of the data to draw
             * @param options{object}
             */
            function DPChart(container, data, options) {
                if (!container || !container.nodeType) {
                    return;
                }

                var defaultOptions = {
                    width: container.clientWidth,
                    height: container.clientHeight,
                    margin: 10
                };

                this.container = container;
                this.data = data || [];
                this.events = new DPChart.CustomEvent();

                this.options = mix(defaultOptions, options || {});

                //initCanvas
                this._initCanvas();
                this.fire('onCanvasInit', this.stage, this.layer);
                //init data
                this._initData();
                this.fire('onDataInit', this.series);

                // init axis
                this._initAxis();
                this.fire('onAxisInit', {});

                //init legend
                this._initLegend();
                this.fire('onLegendInit', this.legend);

                //init grid
                this._initGrid();
                this.fire('onGridInit', this.grid);

                // draw
                this.draw();

                //init events
                this._initEvents();

                this.events.fire('onFinish');

            }
            </textarea>

            <div class="mark-panel">
                <div class="isay-top pngfix"></div>
                <div class="isay-middle pngfix">
                    <div class="mark-box clearfix">
                        <h2>（3）步骤三：调用charts中某类型的draw方法</h2>
                    </div>
                </div>
                <div class="isay-bottom pngfix"></div>
            </div>
            <textarea name="code" class="js" rows="50" cols="100">
            /*
             * add graph type in types
             * @params  name{String} graph name
             * @params  graphType{Object} graphType
             */
            DPChart.addChart = function (name, graphType) {
                charts[name] = graphType;
            }
            </textarea>

            <div class="mark-panel">
                <div class="isay-top pngfix"></div>
                <div class="isay-middle pngfix">
                    <div class="mark-box clearfix">
                        <h2>（4）步骤四：某类型图形所执行的draw方法的具体实现细节</h2>
                    </div>
                </div>
                <div class="isay-bottom pngfix"></div>
            </div>
            <textarea name="code" class="js" rows="50" cols="100">
            DPChart.addChart('pie', {
                draw: function () {


                    //排序
                    var series = this.series.getSeries().sort(function (a, b) {
                        return b.data - a.data ;
                    });
                    var colors = ["skyblue", "orangered",  "yellow", "orange", "violet", "fuchsia", "yellowgreen", "khaki"];

                    var layer = this.layer,
                        stage = this.stage;

                    var percentLayer = this.percentLayer = new Kinetic.Layer();

                    var options = this.options,
                        pieOptions;

                    pieOptions = DPChart.mix({
                        easing: false,
                        radius: 50,
                        needTip: false
                    }, options.pie);

                    //计算饼图的圆心
                    var centerX = this.options.width / 2;
                    var centerY = this.options.height / 2;

                    var sum = 0,
                        path, data;
                    for (var i = 0, L = series.length; i < L; i++) {
                        data = series[i];
                        sum += data.data;
                    }

                    for (var i = 0, L = series.length; i < L; i++) {
                        data = series[i];
                        data.percent = data.data / sum;
                    }
                    var startAngle = 0,
                        endAngle = 0,
                        sector,
                        text,
                        tip, sumAngle = 0,
                        newLayer,
                        stage = this.stage;

                    for (var i = 0, L = series.length; i < L; i++) {

                        data = series[i];
                        endAngle = startAngle + 360 * data.percent;

                        (function (startAngle, endAngle, percent) {

                            //添加扇形
                            var textAngle = (startAngle + endAngle)/2,
                                thisAngle = endAngle - startAngle,
                                textRadius = 0.6 * pieOptions.radius,
                                tipRadius = pieOptions.radius;

                            sumAngle += thisAngle;
                            var tipAngle = sumAngle - thisAngle/2;
                            sector = new Kinetic.Sector({
                                x: centerX,
                                y: centerY,
                                radius: (pieOptions.easing ? 0 : pieOptions.radius),
                                startAngle: (pieOptions.easing ? 0 : pieOptions.radius),
                                endAngle: (pieOptions.easing ? 0 : pieOptions.radius),
                                fill: colors[i],
                                stroke:"white",
                                strokeWidth:1,
                                shadow: {
                                    color: "#000",
                                    blur: 6,
                                    alpha: 0.2
                                }
                            });
                            layer.add(sector);
                            var tipX = centerX + Math.cos(tipAngle * Math.PI /180) * tipRadius;
                            var tipY = centerY + Math.sin(tipAngle * Math.PI /180) * tipRadius;
                            
                            tipAngle = parseInt(tipAngle);

                            

                            //添加扇形上的文字
                            if(percent > 0.14){
                                text = new Kinetic.Text({
                                    text:(percent*100).toFixed(2),
                                    x:centerX + Math.cos(textAngle * Math.PI /180) * textRadius,
                                    y:centerY + Math.sin(textAngle * Math.PI /180) * textRadius,
                                    textFill:"black",
                                    align:"center",
                                    width:30,
                                    offset:{
                                        x: 12
                                    }
                                });
                                percentLayer.add(text);
                            }
                            (function(sector){
                                if ( !! pieOptions.easing) {
                                    sector.transitionTo({
                                        radius: options.pie.radius,
                                        duration: .5,
                                        startAngle: startAngle,
                                        endAngle: endAngle,
                                        easing: pieOptions.easing,
                                        callback:function(){
                                            bindMouseEvent(sector);
                                        }
                                    });
                                }else{
                                    bindMouseEvent(sector);
                                }

                                function bindMouseEvent(sector){
                                    sector.on("mouseover", function () {
                                        
                                        this.transitionTo({
                                            radius: options.pie.radius * 1.1,
                                            duration: 0.2,
                                            easing: "ease-in"
                                        });
                                        
                                        if(pieOptions.needTip) {
                                            var direction = '';
                                            if(tipAngle > 0 && tipAngle < 45) { direction = 'right';}
                                            if(tipAngle > 315 && tipAngle < 360) {
                                                direction = 'right';
                                            } else if(tipAngle >= 45 && tipAngle < 135) {
                                                direction = 'bottom';
                                            } else if(tipAngle >= 135 && tipAngle < 225) {
                                                direction = 'left';
                                            } else {
                                                direction = 'top';
                                            }
                                            newLayer = DPChart.tooltips(tipX, tipY, (percent*100).toFixed(2), direction);
                                            stage.add(newLayer);
                                        }
                                    });
                                    sector.on("mouseout", function () {
                                        this.transitionTo({
                                            radius: options.pie.radius,
                                            duration: 0.2,
                                            easing: "ease-out"
                                        });
                                        pieOptions.needTip && DPChart.toolTipHide(newLayer);
                                    });
                                }

                            }(sector));
                            

                        })(startAngle, endAngle, data.data);

                        startAngle = endAngle;

                    }
                }
            });
            </textarea>

        </div>

    </div>
	<a class="toTop" id="toTop" href="#top"></a>
    <script type="text/javascript" src="Scripts/g.mt.js"></script>
	<script type="text/javascript" src="Scripts/g.dp.js"></script>
	<script type="text/javascript">
	window.addEvent('domready', function() {
		Venus.app.dropMenu();
		TG.app.toTop();
	});
	</script>
    
    <script class="javascript" src="Scripts/shCore.js"></script>
    <script class="javascript" src="Scripts/shBrushJScript.js"></script>
    <script class="javascript" src="Scripts/shBrushCss.js"></script>

    <script class="javascript">
    	dp.SyntaxHighlighter.HighlightAll('code');
    </script>
</body>
</html>
